# Windows 键盘监听程序

语言：[英文](README.md) 中文简体

## 项目简介

Windows键盘监听程序是一个基于 Windows API开发的全局键盘钩子工具，能够实时监控和记录系统范围内的所有键盘输入。该工具支持多种运行模式，包括控制台显示、后台隐藏运行和文件记录等功能。

**⚠️ 重要法律声明：** 本程序仅供学习和研究目的使用。请在您拥有合法权限的设备上使用，不得用于非法监控他人键盘输入。使用者需对使用该工具产生的后果负全部责任。

## 功能特性

### 核心功能
- ✅ **全局键盘监听**：捕获系统范围内的所有键盘输入
- ✅ **按键识别**：精确识别字母、数字、符号、功能键和控制键
- ✅ **小键盘标记**：为小键盘数字添加 `[NUM]` 前缀
- ✅ **时间戳记录**：每条记录包含精确的时间戳
- ✅ **组合键检测**：支持检测和记录组合按键

### 运行模式
- ✅ **交互模式**：在控制台实时显示按键记录
- ✅ **静默模式**：后台运行，无任何界面显示
- ✅ **文件记录**：将按键记录保存到指定文件
- ✅ **隐藏窗口**：完全后台运行，支持系统托盘图标

### 安全特性
- ✅ **管理员权限检测**：自动检测运行权限
- ✅ **安全退出机制**：使用左Ctrl+Win组合键退出
- ✅ **资源清理**：确保正确释放所有系统资源
- ✅ **错误处理**：详细的错误信息和故障处理

## 系统要求

### 操作系统
- Windows 7/8/10/11 (32位或64位)
- Windows Server 2008 R2 及以上版本

### 运行环境
- C++运行库（已静态编译，无需额外安装）
- 管理员权限（推荐）

## 安装与编译

### 编译方法

#### 使用 MinGW (推荐)
```bash
g++ -o keymonitor.exe keymonitor.cpp -luser32 -lgdi32 -lshell32 -static -std=c++11
```

#### 使用 Visual Studio
```bash
cl keymonitor.cpp user32.lib gdi32.lib shell32.lib
```

### 编译选项说明
- `-static`：静态链接，生成独立可执行文件
- `-std=c++11`：使用C++11标准
- `-luser32 -lgdi32 -lshell32`：链接Windows系统库

## 使用方法

### 基本语法
```
keymonitor.exe [选项]
```

### 运行示例

#### 示例1：控制台交互模式
```bash
# 在控制台显示所有按键记录
keymonitor.exe
```
**输出示例：**
```
[2024-01-15 14:30:25] H
[2024-01-15 14:30:25] e
[2024-01-15 14:30:25] l
[2024-01-15 14:30:25] l
[2024-01-15 14:30:25] o
[2024-01-15 14:30:26] [Enter]
```

#### 示例2：文件记录模式
```bash
# 静默运行，记录保存到文件
keymonitor.exe -o keylog.txt
```

#### 示例3：隐藏窗口模式
```bash
# 后台运行，程序结束后显示消息框
keymonitor.exe -h
```

#### 示例4：组合使用
```bash
# 隐藏窗口并记录到文件（完全静默）
keymonitor.exe -h -o keylog.txt
```

#### 示例5：显示帮助
```bash
# 查看完整使用说明
keymonitor.exe --help
```

### 命令行选项

| 选项 | 参数 | 说明 |
|------|------|------|
| `-o` | `<文件名>` | 将按键记录输出到指定文件（自动启用静默模式） |
| `-h` | 无 | 隐藏控制台窗口，后台运行 |
| `--silent` | 无 | 静默模式，不显示任何输出 |
| `--help` | 无 | 显示帮助信息 |

### 退出程序
- **退出组合键**：同时按下 **左Ctrl + Win** 键
- **系统托盘**：右键点击系统托盘图标，选择"退出"
- **程序行为**：退出后会自动保存所有记录并清理资源

## 按键记录格式

### 基本格式
```
[时间戳] [修饰键] + 按键名称
```

### 按键表示规则

#### 普通按键
- 字母：`a`, `b`, `c`, ...
- 数字：`1`, `2`, `3`, ...
- 符号：`!`, `@`, `#`, ...

#### 特殊按键
- 功能键：`[F1]`, `[F2]`, ... `[F12]`
- 方向键：`[Left]`, `[Right]`, `[Up]`, `[Down]`
- 控制键：`[Enter]`, `[Space]`, `[Tab]`, `[Esc]`
- 编辑键：`[Home]`, `[End]`, `[Insert]`, `[Delete]`

#### 修饰键
- 左侧控制键：`[LCtrl]`, `[LShift]`, `[LAlt]`, `[LWin]`
- 右侧控制键：`[RCtrl]`, `[RShift]`, `[RAlt]`, `[RWin]`
- 通用控制键：`[Ctrl]`, `[Shift]`, `[Alt]`, `[Win]`

#### 小键盘按键
```
[NUM] 0
[NUM] 1
[NUM] 2
[NUM] +
[NUM] -
[NUM] *
[NUM] /
[NUM] .
```

### 记录示例

#### 单个按键
```
[2024-01-15 14:30:25] H
[2024-01-15 14:30:25] e
```

#### 组合按键
```
[2024-01-15 14:30:30] [LCtrl][LShift] + s
```

#### 小键盘输入
```
[2024-01-15 14:30:35] [NUM] 1
[2024-01-15 14:30:35] [NUM] 2
[2024-01-15 14:30:35] [NUM] 3
```

## 输出文件格式

### 文件结构
```plaintext
=== 键盘监听记录开始于 2024-01-15 14:30:25 ===
[2024-01-15 14:30:25] H
[2024-01-15 14:30:25] e
[2024-01-15 14:30:25] l
[2024-01-15 14:30:25] l
[2024-01-15 14:30:25] o
[2024-01-15 14:30:26] [Enter]
=== 键盘监听记录结束于 2024-01-15 14:31:00 ===
```

### 文件命名
- 默认文件名：`keylog.txt`
- 自定义文件名：通过 `-o` 参数指定

## 程序架构

### 核心组件

#### 1. 键盘钩子系统
- **全局钩子**：使用 `SetWindowsHookEx(WH_KEYBOARD_LL)` 安装低级键盘钩子
- **回调函数**：`LowLevelKeyboardProc` 处理所有键盘事件
- **按键转换**：`GetKeyName` 将虚拟键码转换为可读字符串

#### 2. 状态管理
- **按键状态**：跟踪控制键的按下/释放状态
- **组合键检测**：`IsExitCombination` 检测退出组合键
- **运行状态**：原子变量确保线程安全

#### 3. 用户界面
- **控制台界面**：实时显示按键记录
- **隐藏窗口**：接收系统消息和处理托盘图标
- **系统托盘**：后台运行时的最小化界面

#### 4. 文件系统
- **日志记录**：使用 `std::ofstream` 异步写入文件
- **文件管理**：自动创建、追加和关闭日志文件
- **格式控制**：统一的时间戳和格式规范

### 数据流程
```
键盘输入 → Windows系统 → 全局钩子 → 回调函数 → 按键处理 → 输出显示/文件记录
```

## 错误处理

### 常见错误及解决方案

#### 错误1：权限不足
```
安装键盘钩子失败! 错误代码: 5
请以管理员身份运行此程序!
```
**解决方案**：以管理员身份运行程序

#### 错误2：文件访问失败
```
无法打开日志文件: keylog.txt
```
**解决方案**：检查文件路径权限，或使用其他文件名

#### 错误3：钩子安装失败
```
安装键盘钩子失败! 错误代码: 1428
```
**解决方案**：重启程序或检查其他程序冲突

### 错误代码参考
- `5`：访问被拒绝，需要管理员权限
- `87`：参数错误
- `1428`：钩子需要有效的模块句柄
- `1413`：钩子类型错误

## 性能优化

### 内存管理
- 使用智能指针管理资源
- 避免内存泄漏的钩子清理
- 高效的文件缓冲区管理

### 性能特性
- 异步文件写入，不影响键盘响应
- 轻量级消息循环，低CPU占用
- 优化的字符串处理，避免不必要的复制

## 安全注意事项

### 合法使用
1. **仅限授权设备**：仅在您拥有合法权限的设备上使用
2. **知情同意**：确保其他使用者知道被监控
3. **数据保护**：妥善保管记录的敏感信息
4. **遵守法律**：遵循当地隐私保护法律法规

### 安全建议
1. **定期清理**：及时删除不需要的记录文件
2. **加密存储**：对敏感日志文件进行加密
3. **访问控制**：限制日志文件的访问权限
4. **使用审计**：记录程序使用情况

## 开发指南

### 代码结构
```
keymonitor.cpp
├── 全局变量声明
├── 工具函数
│   ├── GetCurrentTimeString()
│   ├── GetKeyName()
│   ├── GetModifierState()
│   └── IsExitCombination()
├── 钩子系统
│   └── LowLevelKeyboardProc()
├── 命令行处理
│   └── ParseCommandLine()
├── 界面管理
│   ├── HideConsoleWindow()
│   ├── CreateHiddenWindow()
│   └── WindowProc()
├── 资源管理
│   ├── InitializeProgram()
│   ├── CleanupResources()
│   └── ShowExitInfo()
└── 主函数
    └── main()
```

#### 修改退出组合键
在 `IsExitCombination()` 函数中修改检测逻辑：
```cpp
// 修改为其他组合键
if (vkCode == VK_LCONTROL && vkCode == VK_F12) {
    // 左Ctrl + F12 退出
}
```

## 常见问题解答

### Q1：程序无法捕获某些按键？
**A**：某些安全软件或系统设置可能会阻止全局钩子，尝试关闭安全软件或使用管理员权限。

### Q2：小键盘数字没有显示[NUM]标记？
**A**：确保使用小键盘输入，主键盘区的数字不会显示[NUM]标记。

### Q3：程序在后台如何退出？
**A**：按左Ctrl+Win组合键，或通过系统托盘右键菜单退出。

### Q4：记录文件在哪里？
**A**：默认在当前目录的 `keylog.txt`，或通过 `-o` 参数指定的位置。

### Q5：如何验证程序正在运行？
**A**：检查任务管理器中的进程，或查看系统托盘图标。

## 许可证信息

本项目使用 GPLv3（GNU General Public License v3.0）开源协议，仅供学习和研究使用。未经许可，不得用于商业用途或非法监控。详见 `LEGAL.md` 文件。

---

**免责声明**：本工具仅用于合法目的。开发者不对任何滥用行为负责。使用本工具即表示您同意承担所有相关责任。
