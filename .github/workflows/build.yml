name: Build Windows Key Monitor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  OUTPUT_NAME: keymonitor

jobs:
  build-windows:
    runs-on: windows-latest
    
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSYS2 and MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: |
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-gcc-libs
          base-devel

    - name: Set up build environment
      shell: msys2 {0}
      run: |
        echo "Building Windows Key Monitor"
        echo "GCC Version:"
        gcc --version

    - name: Compile with MinGW (Static Linking)
      shell: msys2 {0}
      run: |
        echo "Compiling with static linking..."
        g++ -o ${{ env.OUTPUT_NAME }}.exe keymonitor.cpp \
          -luser32 -lgdi32 -lshell32 -static \
          -std=c++11 \
          -Wl,--subsystem,windows \
          -Os -s -Wall -Wextra \
          -Wno-missing-field-initializers \
          -Wno-unused-parameter \
          -D_WIN32_WINNT=0x0600
        
        # Check if executable was created
        if [ -f "${{ env.OUTPUT_NAME }}.exe" ]; then
          echo "✅ Compilation successful!"
          file ${{ env.OUTPUT_NAME }}.exe
          echo "File size:"
          ls -lh ${{ env.OUTPUT_NAME }}.exe
        else
          echo "❌ Compilation failed!"
          exit 1
        fi

    - name: Create Release Version (Optimized)
      if: github.event_name == 'release'
      shell: msys2 {0}
      run: |
        echo "Creating release version with additional optimizations..."
        g++ -o ${{ env.OUTPUT_NAME }}-release.exe keymonitor.cpp \
          -luser32 -lgdi32 -lshell32 -static \
          -std=c++11 \
          -Wl,--subsystem,windows \
          -O3 -flto -s -Wall -Wextra \
          -Wno-missing-field-initializers \
          -Wno-unused-parameter \
          -D_WIN32_WINNT=0x0600 \
          -DNDEBUG

    - name: Test the executable
      shell: msys2 {0}
      run: |
        echo "Testing the compiled executable..."
        # Run with --help to test basic functionality
        ./${{ env.OUTPUT_NAME }}.exe --help
        echo "✅ Executable test passed!"

    - name: Get version info
      id: version
      shell: bash
      run: |
        # Extract version using GitHub API or environment variables
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          # Use commit SHA and date
          VERSION="$(date +'%Y%m%d')-${{ github.sha }}"
          # Shorten the SHA to first 7 characters
          VERSION="${VERSION:0:20}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Building version: ${VERSION}"

    - name: Create README for binary
      shell: msys2 {0}
      run: |
        cat > README-BINARY.md << 'EOF'
        # Windows Key Monitor Binary
        
        ## ⚠️ Important Legal Notice
        
        This software is for **EDUCATIONAL AND RESEARCH PURPOSES ONLY**.
        
        ### Usage Instructions:
        1. **Right-click** and select "Run as administrator"
        2. **Command line options:**
           - No arguments: Interactive mode (shows keys in console)
           - `-o filename`: Silent logging to file
           - `-h`: Hide window, run in background
           - `--help`: Show help information
        
        ### Exit Program:
        - Press **Left Ctrl + Win** keys simultaneously
        
        ### System Requirements:
        - Windows 7/8/10/11 (x64)
        - Administrator privileges recommended
        
        ### Legal Disclaimer:
        Use this tool only on devices you own or have explicit permission to monitor.
        The authors are not responsible for any misuse.
        EOF

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-key-monitor-${{ steps.version.outputs.VERSION }}
        path: |
          ${{ env.OUTPUT_NAME }}.exe
          ${{ env.OUTPUT_NAME }}-release.exe
          README-BINARY.md
        if-no-files-found: error
        retention-days: 7

    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.OUTPUT_NAME }}.exe
          ${{ env.OUTPUT_NAME }}-release.exe
          README-BINARY.md
        draft: false
        prerelease: false

  test-compilation:
    runs-on: windows-latest
    needs: build-windows
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-key-monitor-${{ needs.build-windows.outputs.version }}
        
    - name: Verify binary
      run: |
        echo "Verifying compiled binaries..."
        dir *.exe
        echo "✅ Binaries verified!"
        
        echo "Testing basic functionality..."
        if [ -f "keymonitor.exe" ]; then
          echo "Running help command..."
          ./keymonitor.exe --help
        else
          echo "keymonitor.exe not found!"
          exit 1
        fi
